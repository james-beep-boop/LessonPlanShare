# Lesson Plan Exchange — Deployment Guide for DreamHost

This guide walks you through setting up the project from scratch and deploying
it to DreamHost shared hosting at www.sheql.com.

---

## BEFORE YOU START: Credentials Checklist

You will need the following credentials during setup. Gather them as you go
through the DreamHost panel — they all go into the `.env` file on your server
(which is excluded from git and never shared publicly).

| Credential | Where to create it | Example value |
|---|---|---|
| SSH username | DreamHost Panel > Users > Manage Users (set to "Shell user") | `david_sheql` |
| SSH server | Shown on the Manage Users page | `sheql.com` or a DreamHost server name |
| MySQL hostname | Created when you add a database | `mysql.sheql.com` |
| MySQL database name | Websites > MySQL Databases > Add New | `sheql_lessons` |
| MySQL username | Created with the database | `sheql_dbuser` |
| MySQL password | You set this when creating the DB user | (your choice) |
| SMTP email address | Mail > Manage Email > Create Address | `noreply@sheql.com` |
| SMTP password | You set this when creating the email | (your choice) |
| APP_KEY | Auto-generated by `php artisan key:generate` | (don't set manually) |

**You do NOT need to share any of these with anyone.** They live only in the
`.env` file on your server.

---

## PART 1: LOCAL SETUP (on your own computer)

### Prerequisites
- PHP 8.4 installed locally (check with `php -v`)
- Composer installed (https://getcomposer.org)
- A terminal/command prompt

### Step 1: Create the Laravel project

```bash
composer create-project laravel/laravel LessonPlanShare
cd LessonPlanShare
```

### Step 2: Install Laravel Breeze (authentication)

```bash
composer require laravel/breeze --dev
php artisan breeze:install blade
```

When Breeze asks about options, choose the defaults (Blade with Tailwind).
Breeze will try to run `npm install && npm run build`. This will fail if you
don't have Node.js — that's OK. We'll replace the Vite/Tailwind setup with CDN.

### Step 3: Replace Vite with Tailwind CDN

Breeze generates layout files that use `@vite`. We need to remove those.

Open `resources/views/layouts/app.blade.php` and `guest.blade.php`.
Delete any lines containing `@vite(...)`.

Then, our custom `components/layout.blade.php` (provided in this package)
already includes Tailwind via CDN and Alpine.js via CDN, so you'll use
`<x-layout>` in all our custom views instead of Breeze's `<x-app-layout>`.

### Step 4: Copy in the custom files

From this package, copy these files into your Laravel project, overwriting
where indicated:

```
COPY FROM THIS PACKAGE              →  TO YOUR LARAVEL PROJECT
─────────────────────────────────────────────────────────────────
app/Models/User.php                  →  app/Models/User.php (REPLACE)
app/Models/LessonPlan.php            →  app/Models/LessonPlan.php (NEW)
app/Models/Vote.php                  →  app/Models/Vote.php (NEW)

app/Http/Controllers/Auth/RegisteredUserController.php  →  (REPLACE Breeze's)
app/Http/Controllers/DashboardController.php            →  (NEW)
app/Http/Controllers/LessonPlanController.php           →  (NEW)
app/Http/Controllers/VoteController.php                 →  (NEW)

app/Http/Requests/StoreLessonPlanRequest.php            →  (NEW)

app/Mail/LessonPlanUploaded.php                         →  (NEW)
app/Mail/DuplicateContentRemoved.php                    →  (NEW)

app/Console/Commands/DetectDuplicateContent.php         →  (NEW)

database/migrations/2024_01_01_000001_create_lesson_plans_table.php  →  (NEW)
database/migrations/2024_01_01_000002_create_ratings_table.php       →  (NEW, creates votes table)

resources/views/components/layout.blade.php             →  (NEW)
resources/views/components/vote-buttons.blade.php       →  (NEW)
resources/views/dashboard.blade.php                     →  (REPLACE Breeze's)
resources/views/lesson-plans/create.blade.php           →  (NEW)
resources/views/lesson-plans/show.blade.php             →  (NEW)
resources/views/lesson-plans/edit.blade.php             →  (NEW)
resources/views/lesson-plans/my-plans.blade.php         →  (NEW)
resources/views/emails/lesson-plan-uploaded.blade.php   →  (NEW)
resources/views/emails/duplicate-content-removed.blade.php  →  (NEW)

routes/web.php                                          →  (REPLACE)
.gitignore                                              →  (REPLACE)
.env.example                                            →  (REPLACE)
```

### Step 5: Update Breeze auth views to use our layout

Breeze generates auth views in `resources/views/auth/`. These use
`<x-guest-layout>`. You have two options:

**Option A (Quick):** Edit each auth view and change `<x-guest-layout>` to
`<x-layout>` and `</x-guest-layout>` to `</x-layout>`.

**Option B (Thorough):** Keep Breeze's guest layout but update it to use
Tailwind CDN instead of @vite. Open `resources/views/layouts/guest.blade.php`
and replace the `<head>` contents with:
```html
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{{ config('app.name') }}</title>
<script src="https://cdn.tailwindcss.com"></script>
<script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
```

**Important note about registration:** Our custom `RegisteredUserController`
requires the "Name" field to be a valid email address. This is by design — the
system uses the name as the user's display identifier and for email
notifications. Make sure the registration form's "Name" field label is updated
to say something like "Email (used as your display name)" so users understand.

### Step 6: Configure your local .env

```bash
cp .env.example .env
php artisan key:generate
```

Edit `.env` and set your local database credentials. Then:

```bash
php artisan migrate
php artisan storage:link
php artisan serve
```

Visit http://localhost:8000 — you should see the dashboard.

### Step 7: Test locally

1. Register a test account (remember: the "Name" field must be a valid email)
2. Upload a lesson plan — you should see a dialog box confirming the upload
   and showing the renamed filename (e.g., `AP-Biology_Day5_you@email.com_20260221_143022UTC.pdf`)
3. Check your email (if SMTP is configured locally) for the upload confirmation
4. View the plan, download it
5. Create a new version of it
6. Register a second test account and vote on the plan (upvote/downvote)
7. Search and sort on the dashboard
8. Run the duplicate detection command: `php artisan lessons:detect-duplicates --dry-run`

---

## PART 2: DREAMHOST SETUP

### Step 1: Set PHP version to 8.4

1. Log into your DreamHost Panel (https://panel.dreamhost.com)
2. Go to **Websites > Manage Websites**
3. Find sheql.com and click **Manage**
4. Under **PHP**, select **PHP 8.4**
5. Save changes

### Step 2: Enable SSH access for your user

1. Go to **Users > Manage Users**
2. Find the user associated with sheql.com (or create a new one)
3. Make sure the user type is set to **Shell user** (not "SFTP only")
4. Note down the username — you'll use this for all SSH commands below

### Step 3: Create a MySQL database

1. Go to **Websites > MySQL Databases**
2. Click **Add New Database**
3. Set a database name (e.g., `sheql_lessons`)
4. Create a new database user with a strong password, or use an existing one
5. The panel will assign a hostname — note it down (typically `mysql.sheql.com`)
6. Write down all four values: hostname, database name, username, password

### Step 4: Create an email address for SMTP

The application sends email for: password resets, upload confirmations (when a
teacher uploads a lesson plan), and duplicate-content removal notifications.

1. Go to **Mail > Manage Email**
2. Under sheql.com, click **Create Address**
3. Create `noreply@sheql.com` with a password
4. Note down the email address and password

The SMTP settings for DreamHost email are:
- Host: `mail.sheql.com`
- Port: `587`
- Encryption: `TLS`
- Username: `noreply@sheql.com` (the full email address)
- Password: (what you set above)

### Step 5: Back up and clear the existing site

The existing content at www.sheql.com needs to be moved out of the way.
SSH into your server:

```bash
ssh YOUR_USERNAME@sheql.com
```

Then rename the existing web directory to keep it as a backup:

```bash
mv ~/sheql.com ~/sheql.com.old
```

(Don't delete it yet — you can remove it later once the new site is confirmed
working. To delete it when ready: `rm -rf ~/sheql.com.old`)

### Step 6: Install Composer on DreamHost

DreamHost doesn't always have Composer pre-installed. Install it in your
home directory:

```bash
cd ~
php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
php composer-setup.php
php -r "unlink('composer-setup.php');"
```

Now `~/composer.phar` is your Composer. Create an alias so you can just
type `composer`:

```bash
echo 'alias composer="php ~/composer.phar"' >> ~/.bashrc
source ~/.bashrc
```

Verify it works:
```bash
composer --version
```

### Step 7: Upload your project

Since you're using a GitHub repository, clone it directly on the server:

```bash
cd ~
git clone https://github.com/YOUR_GITHUB_USERNAME/LessonPlanShare.git
```

(Replace with your actual repository URL. If it's a private repo, you'll
need to set up a GitHub personal access token or SSH key — see Troubleshooting.)

### Step 8: Install dependencies on the server

```bash
cd ~/LessonPlanShare
composer install --no-dev --optimize-autoloader
```

This may take a few minutes on shared hosting. That's normal.

### Step 9: Configure .env on the server

```bash
cd ~/LessonPlanShare
cp .env.example .env
nano .env
```

Fill in your actual credentials from the checklist above:

```
APP_NAME="Lesson Plan Exchange"
APP_ENV=production
APP_KEY=
APP_DEBUG=false
APP_URL=https://www.sheql.com

DB_CONNECTION=mysql
DB_HOST=mysql.sheql.com
DB_PORT=3306
DB_DATABASE=sheql_lessons
DB_USERNAME=your_db_username
DB_PASSWORD=your_db_password

MAIL_MAILER=smtp
MAIL_HOST=mail.sheql.com
MAIL_PORT=587
MAIL_USERNAME=noreply@sheql.com
MAIL_PASSWORD=your_email_password
MAIL_ENCRYPTION=tls
MAIL_FROM_ADDRESS="noreply@sheql.com"
MAIL_FROM_NAME="Lesson Plan Exchange"
```

Save the file (in nano: Ctrl+O, Enter, Ctrl+X), then generate the app key:

```bash
php artisan key:generate
```

### Step 10: Run database migrations

```bash
php artisan migrate
```

Type `yes` when it asks to confirm running in production.

### Step 11: Point the domain to Laravel's public folder

```bash
ln -s ~/LessonPlanShare/public ~/sheql.com
```

This creates the `sheql.com` directory as a symlink to Laravel's public folder,
which is what DreamHost's web server will serve.

### Step 12: Create the storage symlink

```bash
cd ~/LessonPlanShare
php artisan storage:link
```

If that gives an error, create it manually:
```bash
ln -s ~/LessonPlanShare/storage/app/public ~/sheql.com/storage
```

### Step 13: Set permissions

```bash
chmod -R 775 ~/LessonPlanShare/storage
chmod -R 775 ~/LessonPlanShare/bootstrap/cache
```

### Step 14: Create the lessons upload directory

```bash
mkdir -p ~/LessonPlanShare/storage/app/public/lessons
chmod 775 ~/LessonPlanShare/storage/app/public/lessons
```

### Step 15: Cache configuration for production

```bash
cd ~/LessonPlanShare
php artisan config:cache
php artisan route:cache
php artisan view:cache
```

### Step 16: Set up the duplicate-content detection cron job

This command scans for lesson plans with identical file content (by SHA-256
hash), removes duplicates (keeping the earlier upload), and emails the affected
author. Set it to run daily:

```bash
crontab -e
```

Add this line (runs at 2:00 AM server time daily):

```
0 2 * * * cd ~/LessonPlanShare && /usr/local/php84/bin/php artisan lessons:detect-duplicates >> ~/LessonPlanShare/storage/logs/dedup.log 2>&1
```

**Note:** The exact PHP path may vary on DreamHost. Check with:
```bash
which php
```
Use whatever path that returns (e.g., `/usr/local/php84/bin/php`).

You can also run it manually any time:
```bash
cd ~/LessonPlanShare
php artisan lessons:detect-duplicates --dry-run   # preview only
php artisan lessons:detect-duplicates             # actually delete duplicates
```

### Step 17: Test!

Visit https://www.sheql.com in your browser. You should see the dashboard.

Try registering an account — if email is set up correctly, you'll receive
a verification email at the address you register with. When you upload a
lesson plan, you should see a dialog box showing the canonical filename, and
you should receive a confirmation email.

---

## PART 3: ONGOING MAINTENANCE

### Updating the site after code changes

When you push changes to GitHub and want to deploy them:

```bash
ssh YOUR_USERNAME@sheql.com
cd ~/LessonPlanShare
git pull

composer install --no-dev --optimize-autoloader
php artisan migrate
php artisan config:cache
php artisan route:cache
php artisan view:cache
```

### Monitoring disk usage

Uploaded lesson plan files go to `storage/app/public/lessons/`.
Monitor with:
```bash
du -sh ~/LessonPlanShare/storage/app/public/lessons/
```

### Database backups

```bash
mysqldump -h mysql.sheql.com -u YOUR_DB_USER -p YOUR_DB_NAME > ~/backup_$(date +%Y%m%d).sql
```

### Checking duplicate detection logs

```bash
cat ~/LessonPlanShare/storage/logs/dedup.log
```

### Cleaning up the old site

Once the new site is confirmed working and you no longer need the old content:
```bash
rm -rf ~/sheql.com.old
```

---

## COMPLETE FILE LIST

Here is every custom file in this package (24 files total):

```
LessonPlanShare/
├── .env.example
├── .gitignore
├── DEPLOYMENT.md
├── storage/app/public/lessons/.gitkeep
│
├── database/migrations/
│   ├── 2024_01_01_000001_create_lesson_plans_table.php
│   └── 2024_01_01_000002_create_ratings_table.php   (creates votes table)
│
├── app/Models/
│   ├── User.php
│   ├── LessonPlan.php
│   └── Vote.php
│
├── app/Http/Controllers/
│   ├── Auth/RegisteredUserController.php
│   ├── DashboardController.php
│   ├── LessonPlanController.php
│   └── VoteController.php
│
├── app/Http/Requests/
│   └── StoreLessonPlanRequest.php
│
├── app/Mail/
│   ├── LessonPlanUploaded.php
│   └── DuplicateContentRemoved.php
│
├── app/Console/Commands/
│   └── DetectDuplicateContent.php
│
├── resources/views/
│   ├── components/
│   │   ├── layout.blade.php
│   │   └── vote-buttons.blade.php
│   ├── dashboard.blade.php
│   ├── emails/
│   │   ├── lesson-plan-uploaded.blade.php
│   │   └── duplicate-content-removed.blade.php
│   └── lesson-plans/
│       ├── create.blade.php
│       ├── show.blade.php
│       ├── edit.blade.php
│       └── my-plans.blade.php
│
└── routes/
    └── web.php
```

---

## TROUBLESHOOTING

**500 Error / Blank page:**
- Check the log: `tail -50 ~/LessonPlanShare/storage/logs/laravel.log`
- Temporarily enable debug mode: edit `.env` and set `APP_DEBUG=true`
- Verify permissions: `chmod -R 775 ~/LessonPlanShare/storage ~/LessonPlanShare/bootstrap/cache`
- After fixing, remember to set `APP_DEBUG=false` and run `php artisan config:cache`

**CSS not loading / page looks broken:**
- Make sure you removed all `@vite(...)` references from Breeze layout files
- Our layout uses Tailwind CDN — no build step needed

**File uploads not working:**
- Check that the directory exists: `ls -la ~/LessonPlanShare/storage/app/public/lessons/`
- Verify the storage symlink: `ls -la ~/sheql.com/storage`
- Check PHP's upload limit in DreamHost panel (should be >= 10M)
- You can also add a `.user.ini` in your web directory:
  ```
  upload_max_filesize = 12M
  post_max_size = 13M
  ```

**"Class not found" errors:**
- Run `composer dump-autoload` on the server

**Database connection refused:**
- Double-check DB_HOST — DreamHost uses `mysql.yourdomain.com`, not `localhost`
- Verify credentials by testing manually: `mysql -h mysql.sheql.com -u YOUR_USER -p`

**Email not sending (upload confirmations or password resets don't arrive):**
- Verify SMTP credentials by checking if you can log into webmail at
  https://webmail.sheql.com with the `noreply@sheql.com` address
- Check the Laravel log for mail errors: `tail -20 ~/LessonPlanShare/storage/logs/laravel.log`
- Make sure MAIL_ENCRYPTION is set to `tls` (not `ssl`)
- DreamHost SMTP username must be the full email address, not just the local part
- Upload confirmations are wrapped in try/catch, so a mail failure won't block
  the upload — but you can check the log for "Upload confirmation email failed"

**Permission denied on SSH:**
- Make sure your user is set to "Shell user" (not SFTP) in DreamHost panel
- Try connecting with: `ssh -v YOUR_USERNAME@sheql.com` for verbose output

**Git clone fails (private repo):**
- Generate a personal access token on GitHub: Settings > Developer Settings > Personal Access Tokens
- Use it as the password when prompted during `git clone`
- Or set up an SSH key: `ssh-keygen -t ed25519` then add the public key to GitHub

**Duplicate detection cron not running:**
- Verify the cron entry: `crontab -l`
- Check the PHP path is correct: `which php`
- Look at the log: `cat ~/LessonPlanShare/storage/logs/dedup.log`
- Test manually: `cd ~/LessonPlanShare && php artisan lessons:detect-duplicates --dry-run`
