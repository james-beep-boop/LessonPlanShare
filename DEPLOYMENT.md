# ARES Education — Kenya Lesson Plan Repository: Deployment Guide

**Version:** 2.0
**Date:** February 2026
**Live site:** https://www.sheql.com

This guide covers initial setup, deployment to DreamHost shared hosting, and
the ongoing update workflow.

---

## BEFORE YOU START: Credentials Checklist

You will need the following credentials during setup. They all go into the
`.env` file on your server (which is excluded from git and never shared).

| Credential | Where to create it | Value |
|---|---|---|
| SSH username | DreamHost Panel > Users > Manage Users (Shell user) | `david_sheql` |
| SSH server | Shown on the Manage Users page | `sheql.com` |
| MySQL hostname | Websites > MySQL Databases (must be explicitly created) | `mysql.sheql.com` |
| MySQL database name | Websites > MySQL Databases > Add New | `sheql_lessons` |
| MySQL username | Created with the database | `sheql_dbuser` |
| MySQL password | Set when creating the DB user | (stored in `.env` only) |
| SMTP email address | Mail > Manage Email > Create Address | `david@sheql.com` |
| SMTP password | Set when creating the email address | (stored in `.env` only) |
| APP_KEY | Auto-generated by `php artisan key:generate` | (don't set manually) |

---

## PART 1: LOCAL SETUP (on your own computer)

### Prerequisites
- PHP 8.4 installed locally (check with `php -v`)
- Composer installed (https://getcomposer.org)
- A terminal/command prompt

### Step 1: Create the Laravel project

```bash
composer create-project laravel/laravel LessonPlanShare
cd LessonPlanShare
```

### Step 2: Install Laravel Breeze (authentication)

```bash
composer require laravel/breeze --dev
php artisan breeze:install blade
```

When Breeze asks about options, choose the defaults (Blade with Tailwind).
Breeze will try to run `npm install && npm run build`. This will fail if you
don't have Node.js — that's OK. We replace the Vite/Tailwind setup with CDN.

### Step 3: Replace Vite with Tailwind CDN

Breeze generates layout files that use `@vite`. Remove those lines from
`resources/views/layouts/app.blade.php` and `guest.blade.php`.

Our custom `components/layout.blade.php` already includes Tailwind via CDN
and Alpine.js via CDN, so all custom views use `<x-layout>` instead of
Breeze's `<x-app-layout>`.

### Step 4: Copy in the custom files

From this repository, copy these files into your Laravel project:

```
COPY FROM THIS REPO                  →  TO YOUR LARAVEL PROJECT
─────────────────────────────────────────────────────────────────
app/Models/User.php                  →  app/Models/User.php (REPLACE)
app/Models/LessonPlan.php            →  app/Models/LessonPlan.php (NEW)
app/Models/Vote.php                  →  app/Models/Vote.php (NEW)
app/Models/LessonPlanView.php        →  app/Models/LessonPlanView.php (NEW)

app/Http/Controllers/Auth/AuthenticatedSessionController.php  →  (REPLACE Breeze's)
app/Http/Controllers/Auth/RegisteredUserController.php        →  (REPLACE Breeze's)
app/Http/Controllers/Auth/VerifyEmailController.php           →  (REPLACE Breeze's)
app/Http/Controllers/DashboardController.php            →  (NEW)
app/Http/Controllers/LessonPlanController.php           →  (NEW)
app/Http/Controllers/VoteController.php                 →  (NEW)

app/Http/Requests/StoreLessonPlanRequest.php            →  (NEW)

app/Mail/LessonPlanUploaded.php                         →  (NEW)
app/Mail/DuplicateContentRemoved.php                    →  (NEW)

app/Console/Commands/DetectDuplicateContent.php         →  (NEW)

database/migrations/2024_01_01_000001_create_lesson_plans_table.php  →  (NEW)
database/migrations/2024_01_01_000002_create_ratings_table.php       →  (NEW)
database/migrations/2024_01_01_000003_add_unique_index_to_lesson_plans_name.php  →  (NEW)
database/migrations/2026_02_26_163707_create_lesson_plan_views_table.php         →  (NEW)

resources/views/components/layout.blade.php             →  (NEW)
resources/views/components/vote-buttons.blade.php       →  (NEW)
resources/views/dashboard.blade.php                     →  (REPLACE Breeze's)
resources/views/stats.blade.php                         →  (NEW)
resources/views/auth/login.blade.php                    →  (REPLACE or NEW)
resources/views/auth/register.blade.php                 →  (REPLACE or NEW)
resources/views/auth/forgot-password.blade.php          →  (REPLACE Breeze's)
resources/views/auth/reset-password.blade.php           →  (REPLACE Breeze's)
resources/views/auth/verify-email.blade.php             →  (NEW)
resources/views/lesson-plans/create.blade.php           →  (NEW)
resources/views/lesson-plans/show.blade.php             →  (NEW)
resources/views/lesson-plans/edit.blade.php             →  (NEW)
resources/views/lesson-plans/preview.blade.php          →  (NEW)
resources/views/lesson-plans/my-plans.blade.php         →  (NEW)
resources/views/emails/lesson-plan-uploaded.blade.php   →  (NEW)
resources/views/emails/duplicate-content-removed.blade.php  →  (NEW)

routes/web.php                                          →  (REPLACE)
routes/auth.php                                         →  (REPLACE — standard Breeze auth routes)
.gitignore                                              →  (REPLACE)
.env.example                                            →  (REPLACE)
```

### Step 5: Configure your local .env

```bash
cp .env.example .env
php artisan key:generate
```

Edit `.env` and set your local database credentials. Then:

```bash
php artisan migrate
php artisan storage:link
php artisan serve
```

Visit http://localhost:8000 — you should see the dashboard.

### Step 6: Test locally

1. Register a test account (click Sign In → Sign Up; the username must be a valid email)
2. Upload a lesson plan — you should see a dialog box confirming the upload
   and showing the renamed filename (e.g., `Science_Day3_youremailcom_20260223_143022UTC.pdf`)
3. Check your email (if SMTP is configured locally) for the upload confirmation
4. View the plan, download it
5. Create a new version of it
6. Register a second test account and vote on the plan (upvote/downvote)
7. Search and sort on the dashboard
8. Run the duplicate detection command: `php artisan lessons:detect-duplicates --dry-run`

---

## PART 2: DREAMHOST SETUP (first-time deployment)

### Step 1: Set PHP version to 8.4

1. Log into DreamHost Panel (https://panel.dreamhost.com)
2. Go to **Websites > Manage Websites**
3. Find sheql.com and click **Manage**
4. Under **PHP**, select **PHP 8.4**
5. Save changes

### Step 2: Enable SSH access for your user

1. Go to **Users > Manage Users**
2. Find the user associated with sheql.com (or create a new one)
3. Make sure the user type is set to **Shell user** (not "SFTP only")
4. Note the username — `david_sheql`

**CRITICAL:** When adding or re-adding the domain under **Websites > Manage Websites**, make sure the SFTP user is set to `david_sheql` (not any other user like `dh_wyud2c`). The web directory must be under `/home/david_sheql/sheql.com`. If the domain is assigned to the wrong user, Apache will serve from the wrong home directory and you will see DreamHost's "Site Not Found" page even though all files are in place.

### Step 3: Create a MySQL database

1. Go to **Websites > MySQL Databases**
2. Click **Add New Database**
3. Set a database name: `sheql_lessons`
4. Create a new database user with a strong password, or use existing one
5. **Important:** You must explicitly create the MySQL hostname `mysql.sheql.com` in the panel. This is not automatic — if you delete and re-add the domain, the hostname may be removed and must be re-created.
6. Note all four values: hostname, database name, username, password

**Note:** After creating or re-creating the MySQL hostname, it may take up to a few hours for DNS to propagate. During this time the application will show a 500 error with a "php_network_getaddresses" PDO exception in the Laravel log.

### Step 4: Create an email address for SMTP

1. Go to **Mail > Manage Email**
2. Under sheql.com, click **Create Address**
3. The address `david@sheql.com` is used for this purpose
4. Note the password

SMTP settings for DreamHost:
- Host: `smtp.dreamhost.com` (do NOT use `mail.sheql.com` — it causes a TLS certificate mismatch)
- Port: `587`
- Encryption: `TLS`
- Username: `david@sheql.com` (the full email address)

### Step 5: Back up and clear the existing site

SSH into your server:

```bash
ssh david_sheql@sheql.com
```

Rename the existing web directory (uses a timestamped backup name so this
is safe to run even if a previous backup exists):

```bash
mv ~/sheql.com ~/sheql.com.bak.$(date +%Y%m%d%H%M%S)
```

### Step 6: Install Composer on DreamHost

```bash
cd ~
php -r "copy('https://composer.github.io/installer.sig', 'installer.sig');"
php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
php -r "if (trim(file_get_contents('installer.sig')) !== hash_file('sha384', 'composer-setup.php')) { echo 'ERROR: Invalid installer signature' . PHP_EOL; unlink('composer-setup.php'); unlink('installer.sig'); exit(1); }"
php composer-setup.php --quiet
php -r "unlink('composer-setup.php'); unlink('installer.sig');"
```

Create an alias:

```bash
echo 'alias composer="php ~/composer.phar"' >> ~/.bashrc
source ~/.bashrc
composer --version
```

### Step 7: Create a fresh Laravel project on the server

```bash
cd ~
composer create-project laravel/laravel LessonPlanShare
cd LessonPlanShare
composer require laravel/breeze --dev
php artisan breeze:install blade
```

Breeze may try to run `npm install` — that will fail on DreamHost (no Node.js).
This is fine. We use Tailwind CDN and don't need a build step.

### Step 8: Clone the custom files and overlay them

**Important:** Use `--depth 1` for the clone. DreamHost shared hosting has
limited memory and a full clone may fail with "unable to create thread".

```bash
cd ~
git clone --depth 1 https://github.com/james-beep-boop/LessonPlanShare.git /tmp/LPC
```

If the repository is private, you will be prompted for a username and password.
Use a GitHub Personal Access Token as the password.

Copy the custom files into the Laravel project:

```bash
cp -r /tmp/LPC/app/* ~/LessonPlanShare/app/
cp -r /tmp/LPC/database/* ~/LessonPlanShare/database/
cp -r /tmp/LPC/resources/* ~/LessonPlanShare/resources/
cp -r /tmp/LPC/routes/* ~/LessonPlanShare/routes/
cp -r /tmp/LPC/public/* ~/LessonPlanShare/public/
cp -r /tmp/LPC/storage/* ~/LessonPlanShare/storage/
cp /tmp/LPC/.env.example ~/LessonPlanShare/.env.example
cp /tmp/LPC/.gitignore ~/LessonPlanShare/.gitignore
rm -rf /tmp/LPC
```

### Step 9: Configure .env

```bash
cd ~/LessonPlanShare
cp .env.example .env
nano .env
```

Fill in credentials:

```
APP_NAME="ARES Education"
APP_ENV=production
APP_KEY=
APP_DEBUG=false
APP_URL=https://www.sheql.com

DB_CONNECTION=mysql
DB_HOST=mysql.sheql.com
DB_PORT=3306
DB_DATABASE=sheql_lessons
DB_USERNAME=sheql_dbuser
DB_PASSWORD=your_db_password_here

SESSION_DRIVER=file
SESSION_SECURE_COOKIE=true
SESSION_SAME_SITE=lax

MAIL_MAILER=smtp
MAIL_HOST=smtp.dreamhost.com
MAIL_PORT=587
MAIL_USERNAME=david@sheql.com
MAIL_PASSWORD=your_email_password_here
MAIL_ENCRYPTION=tls
MAIL_FROM_ADDRESS="david@sheql.com"
MAIL_FROM_NAME="ARES Education"
```

Generate the app key:

```bash
php artisan key:generate
```

### Step 10: Run database migrations

```bash
php artisan migrate
```

Type `yes` when it asks to confirm running in production.

### Step 11: Point the domain to Laravel's public folder

Create a symlink from the domain's web directory to Laravel's public folder.
The `-sfn` flags make this idempotent (safe to re-run if the link already exists):

```bash
ln -sfn ~/LessonPlanShare/public ~/sheql.com
```

**Important:** DreamHost requires `Options +FollowSymLinks` in `.htaccess`
for symlinks to work. Laravel's default `public/.htaccess` already includes
this. If you see a 403 or "symbolic link not allowed" error, verify the
`.htaccess` file contains:

```
Options +FollowSymLinks
```

### Step 12: Create the storage symlink

```bash
cd ~/LessonPlanShare
php artisan storage:link
```

If that gives an error, create it manually (idempotent with `-sfn`):
```bash
ln -sfn ~/LessonPlanShare/storage/app/public ~/sheql.com/storage
```

### Step 13: Set permissions

```bash
chmod -R 775 ~/LessonPlanShare/storage
chmod -R 775 ~/LessonPlanShare/bootstrap/cache
```

### Step 14: Create the lessons upload directory

```bash
mkdir -p ~/LessonPlanShare/storage/app/public/lessons
chmod 775 ~/LessonPlanShare/storage/app/public/lessons
```

### Step 15: Clear and rebuild caches for production

```bash
cd ~/LessonPlanShare
php artisan optimize:clear
php artisan config:cache
php artisan route:cache
php artisan view:cache
```

### Step 16: Set up the duplicate-detection cron job

```bash
crontab -e
```

Add this line (runs at 2:00 AM server time daily):

```
0 2 * * * cd ~/LessonPlanShare && /usr/local/php84/bin/php artisan lessons:detect-duplicates >> ~/LessonPlanShare/storage/logs/dedup.log 2>&1
```

Check the PHP path with `which php` and adjust if needed.

### Step 17: Test!

Visit https://www.sheql.com in your browser. You should see the dashboard
with the browser tab showing "ARES: Lesson Plans".

---

## PART 3: ONGOING UPDATES

### The Update Workflow

After making code changes locally and pushing to GitHub:

1. SSH into DreamHost:
   ```bash
   ssh david_sheql@sheql.com
   ```

2. Run the update script:
   ```bash
   bash ~/LessonPlanShare/UPDATE_SITE.sh
   ```

   Or, if the update script itself was changed and you need the latest version:
   ```bash
   curl -sO https://raw.githubusercontent.com/james-beep-boop/LessonPlanShare/main/UPDATE_SITE.sh && bash UPDATE_SITE.sh
   ```

**What the update script does:**
1. Clones the latest code from GitHub into `/tmp/LPC` (shallow clone with `--depth 1`)
2. Copies custom files over the existing Laravel installation
3. Removes stale files via an explicit removal list (never automatic detection — the repo only contains custom overlay files, so automatic comparison would delete Laravel core files)
4. Runs any new database migrations
5. Rebuilds production caches (config, route, view)

The GitHub repository must be **public** for the script to work without
authentication. If the repo is private, the script will fail on the
`git clone` step.

### Monitoring disk usage

```bash
du -sh ~/LessonPlanShare/storage/app/public/lessons/
```

### Database backups

```bash
mysqldump -h mysql.sheql.com -u sheql_dbuser -p sheql_lessons > ~/backup_$(date +%Y%m%d).sql
```

### Checking duplicate detection logs

```bash
cat ~/LessonPlanShare/storage/logs/dedup.log
```

### Cleaning up old site backups

Once the new site is confirmed working:
```bash
rm -rf ~/sheql.com.bak.*
```

---

## COMPLETE FILE LIST

Every custom file in this repository:

```
LessonPlanShare/
├── .env.example
├── .gitignore
├── DEPLOYMENT.md                                       (this file)
├── TECHNICAL_DESIGN.md
├── UPDATE_SITE.sh                                      (one-command deploy script)
├── storage/app/public/lessons/.gitkeep
│
├── database/migrations/
│   ├── 2024_01_01_000001_create_lesson_plans_table.php
│   ├── 2024_01_01_000002_create_ratings_table.php      (creates votes table)
│   ├── 2024_01_01_000003_add_unique_index_to_lesson_plans_name.php
│   └── 2026_02_26_163707_create_lesson_plan_views_table.php
│
├── app/Models/
│   ├── User.php
│   ├── LessonPlan.php
│   ├── Vote.php
│   └── LessonPlanView.php
│
├── app/Http/Controllers/
│   ├── Auth/RegisteredUserController.php
│   ├── Auth/VerifyEmailController.php                  (session-free verification)
│   ├── DashboardController.php                         (index + stats pages)
│   ├── LessonPlanController.php                        (CRUD + preview + download)
│   └── VoteController.php
│
├── app/Http/Requests/
│   └── StoreLessonPlanRequest.php
│
├── app/Mail/
│   ├── LessonPlanUploaded.php
│   └── DuplicateContentRemoved.php
│
├── app/Console/Commands/
│   └── DetectDuplicateContent.php
│
├── resources/views/
│   ├── auth/
│   │   ├── login.blade.php                             (standalone login fallback)
│   │   ├── register.blade.php                          (standalone register fallback)
│   │   ├── forgot-password.blade.php                   (password reset request)
│   │   ├── reset-password.blade.php                    (set new password)
│   │   └── verify-email.blade.php                      (email verification page)
│   ├── components/
│   │   ├── layout.blade.php                            (master layout with auth modal)
│   │   └── vote-buttons.blade.php
│   ├── dashboard.blade.php                             (main page with counters)
│   ├── stats.blade.php                                 (statistics page)
│   ├── emails/
│   │   ├── lesson-plan-uploaded.blade.php
│   │   └── duplicate-content-removed.blade.php
│   └── lesson-plans/
│       ├── create.blade.php
│       ├── show.blade.php
│       ├── edit.blade.php
│       ├── preview.blade.php                           (Google Docs Viewer)
│       └── my-plans.blade.php
│
└── routes/
    ├── web.php
    └── auth.php                                       (Breeze auth routes)
```

---

## TROUBLESHOOTING

**DreamHost "Site Not Found" page (HTTP 200):**
This is NOT a 404. It means Apache has no virtual host configured for your
domain pointing to the correct directory. Check:
- The domain is assigned to the correct SFTP user (`david_sheql`) in the DreamHost panel
- The web directory path is `/home/david_sheql/sheql.com`
- If the non-editable prefix shows a different user (e.g., `/home/dh_wyud2c/`), delete the domain and re-add it, selecting `david_sheql` from the SFTP user dropdown

**500 Error / Blank page:**
- Check the log: `tail -50 ~/LessonPlanShare/storage/logs/laravel.log`
- Temporarily enable debug mode: edit `.env`, set `APP_DEBUG=true`, then
  `php artisan optimize:clear`
- Common cause: MySQL hostname `mysql.sheql.com` not resolving (re-create it in DreamHost panel; may take hours to propagate)
- Verify permissions: `chmod -R 775 ~/LessonPlanShare/storage ~/LessonPlanShare/bootstrap/cache`
- After fixing, set `APP_DEBUG=false` and rebuild caches:
  `php artisan optimize:clear && php artisan config:cache && php artisan route:cache && php artisan view:cache`

**git clone fails with "unable to create thread":**
- Use `--depth 1` for a shallow clone (DreamHost shared hosting has limited memory)
- Example: `git clone --depth 1 https://github.com/james-beep-boop/LessonPlanShare.git /tmp/LPC`

**CSS not loading / page looks broken:**
- Make sure you removed all `@vite(...)` references from Breeze layout files
- Our layout uses Tailwind CDN — no build step needed

**File uploads not working:**
- Check that the directory exists: `ls -la ~/LessonPlanShare/storage/app/public/lessons/`
- Verify the storage symlink: `ls -la ~/sheql.com/storage`
- File limit is 1 MB (enforced by both client-side JS and server-side validation)

**"Class not found" errors:**
- Run `composer dump-autoload` on the server

**Database connection refused (PDOException):**
- Double-check DB_HOST — DreamHost uses `mysql.sheql.com`, not `localhost`
- The MySQL hostname must be explicitly created in the DreamHost panel
- If you recently deleted and re-added the domain, the hostname may have been removed
- Verify credentials: `mysql -h mysql.sheql.com -u sheql_dbuser -p`

**Symlink errors ("symbolic link not allowed"):**
- Verify `Options +FollowSymLinks` is in `public/.htaccess`
- Check that `~/sheql.com` is a symlink: `ls -la ~/sheql.com`

**Email not sending:**
- Verify SMTP credentials at https://webmail.sheql.com
- Check the Laravel log: `tail -20 ~/LessonPlanShare/storage/logs/laravel.log`
- MAIL_ENCRYPTION must be `tls` (not `ssl`)
- MAIL_USERNAME must be the full email address (`david@sheql.com`)
- Upload confirmations are wrapped in try/catch; mail failure won't block uploads

**Permission denied on SSH:**
- Make sure user is set to "Shell user" (not SFTP) in DreamHost panel

**Git clone fails (private repo):**
- The repository must be public for the UPDATE_SITE.sh script to work
- If private: generate a Personal Access Token on GitHub (Settings > Developer Settings > Personal Access Tokens)

**`.env` changes not taking effect:**
- If you ran `php artisan config:cache`, Laravel reads from cache and ignores `.env`
- Clear first: `php artisan optimize:clear` then rebuild: `php artisan config:cache`

**Duplicate detection cron not running:**
- Verify: `crontab -l`
- Check PHP path: `which php`
- Log: `cat ~/LessonPlanShare/storage/logs/dedup.log`
- Test: `cd ~/LessonPlanShare && php artisan lessons:detect-duplicates --dry-run`

---

## DREAMHOST QUIRKS & LESSONS LEARNED

These are issues specific to DreamHost shared hosting that were discovered during deployment. Keep this section as a reference for troubleshooting.

**1. SMTP host must be `smtp.dreamhost.com`, NOT `mail.sheql.com`**
DreamHost's shared mail servers use a wildcard TLS certificate for `*.dreamhost.com`. If you set `MAIL_HOST=mail.sheql.com`, Laravel will fail with:
```
Peer certificate CN='*.dreamhost.com' did not match expected CN='mail.sheql.com'
```
Always use `smtp.dreamhost.com` as the SMTP host.

**2. Email verification link must NOT require auth middleware**
When a user clicks the verification link from their email, it typically opens in a new browser tab (or a different browser entirely) where no Laravel session exists. If the verification route requires the `auth` middleware, the user gets a 403 "THIS ACTION IS UNAUTHORIZED" error. The custom `VerifyEmailController` solves this by validating the signed URL cryptographically and logging the user in without requiring an existing session.

**3. MySQL hostname must be explicitly created and may take hours**
The hostname `mysql.sheql.com` must be manually created in the DreamHost panel under Websites > MySQL Databases. This is NOT automatic. If the domain is deleted and re-added, the hostname may be removed. After creating or re-creating it, DNS propagation can take up to a few hours. During this time, the app will show 500 errors with `php_network_getaddresses` PDO exceptions.

**4. SFTP user assignment is critical**
When adding a domain in the DreamHost panel, the SFTP user dropdown determines which home directory Apache serves from. If the domain is assigned to the wrong user (e.g., `dh_wyud2c` instead of `david_sheql`), Apache will serve from `/home/dh_wyud2c/sheql.com` instead of `/home/david_sheql/sheql.com`, resulting in a "Site Not Found" page even though all files are correctly placed.

**5. Use `--depth 1` for git clone (memory limits)**
DreamHost shared hosting has limited memory. A full git clone may fail with "unable to create thread". Always use `git clone --depth 1` for shallow clones.

**6. Overlay repo — NEVER use automatic stale file detection**
This repository only contains custom overlay files, not a complete Laravel installation. The `UPDATE_SITE.sh` script uses an explicit removal list for stale files. Automatic file comparison (e.g., "delete any file on server not in repo") would catastrophically delete all Laravel core files, Breeze files, Composer dependencies, and more. Any stale file cleanup must be done by manually adding filenames to the removal list in the script.

**7. No Node.js / no build step**
DreamHost shared hosting does not have Node.js. The `npm install && npm run build` step from Breeze installation will fail — this is expected. All frontend assets (Tailwind CSS, Alpine.js) are loaded via CDN. Remove any `@vite(...)` references from Breeze layout files.

**8. Config cache masks .env changes**
After running `php artisan config:cache`, Laravel reads from the cache and ignores `.env` entirely. If you change `.env` values, you MUST clear and rebuild: `php artisan optimize:clear && php artisan config:cache && php artisan route:cache && php artisan view:cache`.

---

## PRODUCTION SECURITY CHECKLIST

After deployment, verify these settings:

- `APP_ENV=production` in `.env`
- `APP_DEBUG=false` in `.env`
- `SESSION_SECURE_COOKIE=true` in `.env` (requires HTTPS)
- `SESSION_SAME_SITE=lax` in `.env`
- `.env` file is NOT committed to git (check with `git status`)
- `storage/` and `bootstrap/cache/` are writable (775)
- Config cache is rebuilt after any `.env` change
- Cron uses absolute paths (check with `crontab -l`)
- GitHub repository is public (required for UPDATE_SITE.sh)
